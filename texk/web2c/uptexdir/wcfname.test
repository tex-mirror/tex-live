#! /bin/sh -vx
#
# Copyright 2022 Japanese TeX Development Community <issue@texjp.org>
# You may freely use, modify and/or distribute this file.

test -d uptests || mkdir -p uptests
rm -f uptests/fn*.log uptests/fn*.txt uptests/fn*.tex fn*.tex

rc=0

TEXMFCNF=$srcdir/../kpathsea
TEXINPUTS=uptests:.
export TEXMFCNF TEXINPUTS

LC_ALL=C.UTF-8; LANGUAGE=C.UTF-8; export LC_ALL LANGUAGE

perl $srcdir/tests/fn-generate.perl || exit 128
mv fn*.tex uptests/

# upTeX internal encoding
fenc="utf8"
for ienc in euc sjis uptex; do
for doc in fn-$fenc fnさざ波-$fenc fn£¥µÆÇñß-$fenc; do

  if [ $ienc != uptex -a $doc = fn£¥µÆÇñß-$fenc ]; then
    continue
  fi

  if [ "$COMSPEC" != "" ]; then
    echo "*** We guess OS is Windows."
    if [ $ienc = uptex ]; then
      command_line_encoding=utf8
      export command_line_encoding
    else
      command_line_encoding=none
      export command_line_encoding
    fi
  fi

  echo '>>> Document:'$doc '  File Encoding:'$fenc '  Internal Encoding:'$ienc
  ./uptex -ini -interaction nonstopmode -jobname=$doc-$ienc -kanji=$fenc --kanji-internal=$ienc --shell-escape $doc.tex >uptests/$doc-$ienc-term.log || rc=1
  mv $doc-$ienc.txt $doc-$ienc.log fn*-tmp.tex uptests/
  diff uptests/$doc-$ienc.txt $srcdir/tests/fn-$fenc.txt || rc=2

done
done


# pTeX compatible mode, regacy encoding
for fenc in sjis euc; do
for doc in fnさざ波-$fenc; do

  ienc=$fenc
  if [ "$COMSPEC" != "" ]; then
    echo "*** We guess OS is Windows."
    if [ $fenc != euc ]; then ienc="sjis"; fi
    if [ $ienc = uptex ]; then
      command_line_encoding=utf8
      export command_line_encoding
    else
      command_line_encoding=none
      export command_line_encoding
    fi
  else
    echo "*** We guess OS is not Windows."
    if [ $fenc != sjis ]; then ienc="euc"; fi
  fi
  if [ $ienc != uptex ]; then
    guess_input_kanji_encoding=1
    export guess_input_kanji_encoding
  fi

  echo '>>> Document:'$doc '  File Encoding:'$fenc '  Internal Encoding:'$ienc
  ./uptex -ini -interaction nonstopmode -jobname=$doc-$ienc -kanji=$fenc --kanji-internal=$ienc --shell-escape $doc.tex >uptests/$doc-$fenc-term.log || rc=3
  mv $doc-$ienc.txt $doc-$ienc.log fn*-tmp.tex uptests/
  diff uptests/$doc-$ienc.txt $srcdir/tests/fn-$fenc.txt || rc=4

done
done


exit $rc
